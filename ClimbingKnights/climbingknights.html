<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Climbing Knights</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --primary: #FFD700;
            --danger: #FF4444;
            --bg: #1a1a1a;
            --ui-bg: rgba(0, 0, 0, 0.85);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Noto Sans KR', sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none; /* Î™®Î∞îÏùº ÌÑ∞Ïπò ÌôïÎåÄ Î∞©ÏßÄ */
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 480px;
            height: 100%;
            max-height: 854px;
            background: #222;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlay Layer */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .ui-element {
            pointer-events: auto;
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--ui-bg);
            display: none; /* JSÎ°ú Ï†úÏñ¥ */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            backdrop-filter: blur(5px);
        }

        .screen.active {
            display: flex;
        }

        h1 {
            font-family: 'Black Ops One', cursive;
            font-size: 48px;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
            text-align: center;
            line-height: 1;
        }
        
        h2 { margin-top: 0; color: #ccc; font-size: 18px; font-weight: normal; }

        .btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            color: #000;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
            transition: transform 0.1s, filter 0.2s;
            text-transform: uppercase;
            font-family: 'Black Ops One', cursive;
        }

        .btn:active { transform: scale(0.95); }
        .btn-secondary { background: #444; color: white; box-shadow: none; font-family: 'Noto Sans KR'; font-size: 16px;}

        input {
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #333;
            color: white;
            margin: 10px;
            width: 200px;
            text-align: center;
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 5;
            font-family: 'Black Ops One', cursive;
            text-shadow: 1px 1px 2px black;
        }
        
        .hud-item { font-size: 24px; color: white; }
        .hud-gold { color: var(--primary); }
        .zone-tag {
            position: absolute;
            top: 60px;
            width: 100%;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 1s;
            text-shadow: 0 0 10px black;
            pointer-events: none;
        }

        /* Shop Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
            width: 90%;
        }

        .skin-card {
            background: #333;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .skin-card.selected { border-color: var(--primary); background: #444; }
        .skin-card.locked { opacity: 0.7; }
        .skin-icon { font-size: 32px; margin-bottom: 5px; }
        .skin-name { font-weight: bold; font-size: 14px; }
        .skin-price { color: var(--primary); font-size: 12px; }
        .skin-desc { font-size: 10px; color: #aaa; margin-top: 5px; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud" style="display: none;">
        <div class="hud-item hud-dist">0m</div>
        <div class="hud-item hud-gold">0 G</div>
    </div>
    <div id="zoneTag" class="zone-tag">BASIC ZONE</div>

    <!-- Login Screen -->
    <div id="screen-login" class="screen active">
        <h1>Climbing<br>Knights</h1>
        <h2>Ascend the Demon King's Tower</h2>
        <input type="text" id="username" placeholder="Í∏∞ÏÇ¨ Ïù¥Î¶Ñ ÏûÖÎ†•" maxlength="12">
        <button class="btn" onclick="gameApp.login()">Í≤åÏûÑ ÏãúÏûë</button>
    </div>

    <!-- Main Menu -->
    <div id="screen-menu" class="screen">
        <h1>MAIN MENU</h1>
        <div style="margin-bottom: 20px; text-align: center;">
            <p>ÌôòÏòÅÌï©ÎãàÎã§, <span id="menu-username" style="color:var(--primary)">User</span>Îãò</p>
            <p>ÏµúÍ≥† Í∏∞Î°ù: <span id="menu-best">0m</span></p>
            <p>Î≥¥Ïú† Í≥®Îìú: <span id="menu-gold" style="color:var(--primary)">0 G</span></p>
        </div>
        <button class="btn" onclick="gameApp.startGame()">PLAY NOW</button>
        <button class="btn btn-secondary" onclick="gameApp.openShop()">ÏÉÅÏ†ê (Shop)</button>
        <button class="btn btn-secondary" style="font-size:12px; margin-top:20px;" onclick="gameApp.logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
    </div>

    <!-- Shop Screen -->
    <div id="screen-shop" class="screen">
        <h2>ARMORY</h2>
        <div style="margin-bottom:10px;">Í≥®Îìú: <span id="shop-gold" style="color:var(--primary)">0</span></div>
        <div class="shop-grid" id="shop-list">
            <!-- Skin Items generated by JS -->
        </div>
        <button class="btn btn-secondary" onclick="gameApp.showScreen('screen-menu')">Îí§Î°úÍ∞ÄÍ∏∞</button>
    </div>

    <!-- Game Over Screen -->
    <div id="screen-gameover" class="screen">
        <h1 style="color: var(--danger)">GAME OVER</h1>
        <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; width: 80%;">
            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;"><span id="go-dist">0</span>m</p>
            <p>ÌöçÎìù Í≥®Îìú: <span id="go-gold" style="color:var(--primary)">+0</span></p>
            <hr style="border-color:#555">
            <p style="font-size: 14px; color:#aaa;">Best: <span id="go-best">0</span>m</p>
        </div>
        <button class="btn" onclick="gameApp.startGame()">Îã§Ïãú ÎèÑÏ†Ñ</button>
        <button class="btn btn-secondary" onclick="gameApp.showScreen('screen-menu')">Î©îÏù∏ Î©îÎâ¥</button>
    </div>
</div>

<script>
/**
 * CLIMBING KNIGHTS - Single File Implementation
 * 2026-02-01 Implementation based on user GDD
 */

// --- Constants & Config ---
const CONSTANTS = {
    PHYSICS: {
        JUMP_SPEED: 15,
        GRAVITY: 0.35, // Adjusted for 60fps canvas feel
        WALL_BOUNCE: 0.6,
        FRICTION: 0.99
    },
    GAME: {
        SCREEN_WIDTH: 480,
        SCREEN_HEIGHT: 854,
        HOLD_GRAB_DIST: 50, // Pixel distance to grab
        ARROW_SPEED: 3 // Degrees per frame
    },
    ZONES: [
        { start: 0, name: "BASIC ZONE", color: "#333", holdTypes: ['normal', 'breaking'] },
        { start: 2000, name: "ROCK ZONE", color: "#4A3B32", holdTypes: ['normal', 'breaking', 'rock_bug'] },
        { start: 4000, name: "SNOW ZONE", color: "#5D7687", holdTypes: ['normal', 'ice', 'snow_bug'] },
        { start: 6000, name: "LAVA ZONE", color: "#4A1C1C", holdTypes: ['normal', 'lava', 'lava_bug'] },
        { start: 8000, name: "CASTLE ZONE", color: "#1A0F2E", holdTypes: ['normal', 'magic', 'trap'] }
    ]
};

// --- Skin Data ---
const SKINS = {
    knight: { name: "Knight", price: 0, desc: "Í∑†ÌòïÏû°Ìûå Í∏∞Î≥∏ Í∏∞ÏÇ¨", color: "#CCC", jumpMult: 1, goldMult: 1, icon: "üõ°Ô∏è" },
    golden: { name: "Golden", price: 500, desc: "Í≥®Îìú ÌöçÎìù 2Î∞∞", color: "#FFD700", jumpMult: 1, goldMult: 2, icon: "üëë" },
    hero: { name: "Hero", price: 800, desc: "1Ìöå Î∂ÄÌôú (ÎØ∏Íµ¨ÌòÑ)", color: "#4CAF50", jumpMult: 1, goldMult: 1, icon: "üó°Ô∏è" },
    princess: { name: "Princess", price: 600, desc: "Ïö∞ÏïÑÌïú ÎìúÎ†àÏä§", color: "#FF69B4", jumpMult: 1, goldMult: 1, icon: "üëó" },
    assassin: { name: "Assassin", price: 900, desc: "Ìï®Ï†ï Î¨¥Ïãú", color: "#9C27B0", jumpMult: 1, goldMult: 1, icon: "ü•∑" },
    samurai: { name: "Samurai", price: 1200, desc: "Ï†êÌîÑÎ†•‚Üì Î∞îÏúÑÎ¨¥Ïãú", color: "#B71C1C", jumpMult: 0.7, goldMult: 1, icon: "üëπ" },
    elf: { name: "Elf", price: 1500, desc: "Ï†êÌîÑ Í±∞Î¶¨ 2Î∞∞", color: "#76FF03", jumpMult: 1.5, goldMult: 1, icon: "üßù" }
};

// --- Game Classes ---

class Hold {
    constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.radius = type === 'ice' ? 40 : 20; // Visual radius
        this.hitbox = type === 'ice' ? 50 : 35; // Grab radius
        this.active = true;
        this.visible = true;
        this.timer = 0;
        this.originalX = x;
        this.originalY = y;
        this.hasGold = Math.random() < 0.3;
        this.goldAmount = Math.floor(Math.random() * 10) + 1;
        
        // Type specific init
        if (type === 'breaking') this.breakTimer = 120; // 2 seconds at 60fps
        if (type === 'lava') {
            this.cycleTimer = 0;
            this.visible = true;
        }
        if (type === 'ice') {
            this.width = 120;
            this.height = 30;
        }
    }

    update(dt, playerY) {
        this.timer += dt;

        // Behaviors
        if (this.type === 'rock_bug') {
            this.x = this.originalX + Math.sin(this.timer * 0.05) * 50;
        } else if (this.type === 'rock_bug_vertical') {
            this.y = this.originalY + Math.sin(this.timer * 0.05) * 50;
        } else if (this.type === 'snow_bug') {
            this.x = this.originalX + Math.sin(this.timer * 0.1) * 80; // Fast
        } else if (this.type === 'ice' && this.grabbed) {
            this.y += 1; // Slide down
            this.originalY += 1;
        } else if (this.type === 'lava') {
            this.cycleTimer++;
            // 4 sec visible (240f), 2 sec gone (120f)
            if (this.cycleTimer < 240) {
                this.visible = true;
                this.active = true;
            } else if (this.cycleTimer < 360) {
                this.visible = false;
                this.active = false;
            } else {
                this.cycleTimer = 0;
            }
        } else if (this.type === 'magic') {
            // Teleport every 1.5s (90f)
            if (this.timer % 90 === 0) {
                this.x = (this.originalX + Math.random() * 100 - 50);
                this.y = (this.originalY + Math.random() * 100 - 50);
            }
        }
        
        // Breaking logic handled in player interaction
    }

    draw(ctx) {
        if (!this.visible) return;

        ctx.save();
        ctx.translate(this.x, this.y);

        // Draw Hold Body
        if (this.type === 'ice') {
            ctx.fillStyle = '#AEEEEE';
            ctx.fillRect(-this.width/2, -10, this.width, 20);
        } else {
            // Base Color
            switch(this.type) {
                case 'normal': ctx.fillStyle = '#888'; break;
                case 'breaking': 
                    ctx.fillStyle = (this.grabbed && this.breakTimer < 30 && this.breakTimer % 10 < 5) ? '#FF0000' : '#8B4513'; 
                    break;
                case 'rock_bug': case 'rock_bug_vertical': ctx.fillStyle = '#5D4037'; break;
                case 'snow_bug': ctx.fillStyle = '#E0F7FA'; break;
                case 'lava_bug': ctx.fillStyle = '#FF5722'; break;
                case 'lava': ctx.fillStyle = '#BF360C'; break;
                case 'magic': ctx.fillStyle = `hsl(${this.timer % 360}, 70%, 50%)`; break;
                case 'trap': ctx.fillStyle = '#3E2723'; break;
                default: ctx.fillStyle = '#888';
            }

            ctx.beginPath();
            ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Detail / Highlight
            ctx.beginPath();
            ctx.arc(-5, -5, 5, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.fill();
        }

        // Draw Gold if uncollected
        if (this.hasGold) {
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(10, -10, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#DAA520';
            ctx.stroke();
        }

        ctx.restore();
    }
}

class Player {
    constructor(skinData) {
        this.x = CONSTANTS.GAME.SCREEN_WIDTH / 2;
        this.y = CONSTANTS.GAME.SCREEN_HEIGHT - 150;
        this.vx = 0;
        this.vy = 0;
        this.radius = 15;
        this.state = 'ON_HOLD'; // ON_HOLD, JUMPING, FALLING, DEAD
        this.angle = -90; // Up
        this.angleDir = 1;
        this.skin = skinData;
        this.currentHold = null;
        this.scoreDistance = 0;
        this.collectedGold = 0;
    }

    update(holds, obstacleManager, cameraY) {
        if (this.state === 'DEAD') return;

        // Distance Calculation (Inverted Y)
        let currentDist = Math.floor((CONSTANTS.GAME.SCREEN_HEIGHT - 100 - this.y) / 10);
        if (currentDist > this.scoreDistance) this.scoreDistance = currentDist;

        if (this.state === 'ON_HOLD') {
            // Arrow oscillation
            this.angle += CONSTANTS.GAME.ARROW_SPEED * this.angleDir;
            if (this.angle > -30) this.angleDir = -1;
            if (this.angle < -150) this.angleDir = 1;

            if (this.currentHold) {
                this.x = this.currentHold.x;
                this.y = this.currentHold.y + 25; // Hang below hold
                
                // Breaking Hold Logic
                if (this.currentHold.type === 'breaking' && this.skin.name !== 'Assassin') {
                    this.currentHold.breakTimer--;
                    if (this.currentHold.breakTimer <= 0) {
                        this.currentHold.active = false;
                        this.currentHold.visible = false; // Visual break
                        this.fall();
                    }
                }
                
                // Lava Logic
                if (this.currentHold.type === 'lava' && !this.currentHold.active) {
                    this.fall();
                }
            }
        } else if (this.state === 'JUMPING') {
            // Physics
            this.vy += CONSTANTS.PHYSICS.GRAVITY;
            this.x += this.vx;
            this.y += this.vy;

            // Wall Bounce
            if (this.x < this.radius) {
                this.x = this.radius;
                this.vx *= -CONSTANTS.PHYSICS.WALL_BOUNCE;
            }
            if (this.x > CONSTANTS.GAME.SCREEN_WIDTH - this.radius) {
                this.x = CONSTANTS.GAME.SCREEN_WIDTH - this.radius;
                this.vx *= -CONSTANTS.PHYSICS.WALL_BOUNCE;
            }

            // Fall check
            if (this.y > cameraY + CONSTANTS.GAME.SCREEN_HEIGHT + 100) {
                this.die();
            }
        }
    }

    jump() {
        if (this.state !== 'ON_HOLD') return;
        
        const rad = this.angle * Math.PI / 180;
        const speed = CONSTANTS.PHYSICS.JUMP_SPEED * this.skin.jumpMult;
        
        this.vx = Math.cos(rad) * speed;
        this.vy = Math.sin(rad) * speed;
        this.state = 'JUMPING';
        
        if (this.currentHold) {
            this.currentHold.grabbed = false;
            this.currentHold = null;
        }
    }

    tryGrab(holds) {
        if (this.state !== 'JUMPING') return false;

        // Find nearest hold
        for (let hold of holds) {
            if (!hold.active) continue;
            
            const dx = this.x - hold.x;
            const dy = (this.y - 25) - hold.y; // Adjust for hand position
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < CONSTANTS.GAME.HOLD_GRAB_DIST) {
                // Success Grab
                this.state = 'ON_HOLD';
                this.vx = 0;
                this.vy = 0;
                this.currentHold = hold;
                hold.grabbed = true;
                
                // Collect Gold
                if (hold.hasGold) {
                    this.collectedGold += hold.goldAmount * this.skin.goldMult;
                    hold.hasGold = false;
                    // Visual popup could go here
                }
                return true;
            }
        }
        return false;
    }

    fall() {
        this.state = 'JUMPING';
        this.currentHold = null;
        // Small push to simulate falling off
        this.vy = 2; 
    }

    die() {
        this.state = 'DEAD';
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);

        // Draw Player Body
        ctx.fillStyle = this.skin.color;
        
        // Body
        ctx.beginPath();
        ctx.ellipse(0, 0, 10, 15, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Head
        ctx.beginPath();
        ctx.arc(0, -15, 12, 0, Math.PI * 2);
        ctx.fill();
        
        // Eyes
        ctx.fillStyle = 'white';
        if (this.state === 'DEAD') {
            ctx.fillText("x x", -6, -12);
        } else {
            ctx.beginPath();
            ctx.arc(-4, -15, 3, 0, Math.PI * 2);
            ctx.arc(4, -15, 3, 0, Math.PI * 2);
            ctx.fill();
        }

        // Arrow (only when on hold)
        if (this.state === 'ON_HOLD') {
            ctx.rotate(this.angle * Math.PI / 180);
            ctx.fillStyle = 'rgba(255, 0, 0, 0.6)';
            ctx.beginPath();
            ctx.moveTo(40, -10);
            ctx.lineTo(60, 0);
            ctx.lineTo(40, 10);
            ctx.fill();
            
            // Dotted line
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(50, 0);
            ctx.stroke();
        }

        ctx.restore();
    }
}

// --- Main Application ---
class GameApp {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        // Resize handling
        this.resize();
        window.addEventListener('resize', () => this.resize());

        // State
        this.user = null;
        this.userData = { gold: 0, skins: ['knight'], currentSkin: 'knight', bestDist: 0 };
        this.gameRunning = false;
        
        // Game Objects
        this.player = null;
        this.holds = [];
        this.cameraY = 0;
        this.bgY = 0;
        this.frameCount = 0;
        
        // Input
        this.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.handleInput(); }, {passive: false});
        this.canvas.addEventListener('mousedown', (e) => { this.handleInput(); });
        
        // Init UI
        this.loadUser(); // Try auto login
        this.renderShop();
    }

    resize() {
        const container = document.getElementById('game-container');
        this.canvas.width = container.clientWidth;
        this.canvas.height = container.clientHeight;
        CONSTANTS.GAME.SCREEN_WIDTH = this.canvas.width;
        CONSTANTS.GAME.SCREEN_HEIGHT = this.canvas.height;
    }

    // --- Data Management ---
    login() {
        const input = document.getElementById('username');
        const name = input.value.trim();
        if (!name) return alert("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
        
        this.user = name;
        this.loadData();
        this.updateMenuUI();
        this.showScreen('screen-menu');
    }

    logout() {
        this.user = null;
        localStorage.removeItem('ck_last_user');
        this.showScreen('screen-login');
    }

    loadUser() {
        const lastUser = localStorage.getItem('ck_last_user');
        if (lastUser) {
            this.user = lastUser;
            this.loadData();
            this.updateMenuUI();
            this.showScreen('screen-menu');
        } else {
            this.showScreen('screen-login');
        }
    }

    loadData() {
        localStorage.setItem('ck_last_user', this.user);
        const data = localStorage.getItem(`ck_data_${this.user}`);
        if (data) {
            this.userData = JSON.parse(data);
        } else {
            // New user defaults
            this.userData = { gold: 0, skins: ['knight'], currentSkin: 'knight', bestDist: 0 };
        }
    }

    saveData() {
        if (!this.user) return;
        localStorage.setItem(`ck_data_${this.user}`, JSON.stringify(this.userData));
    }

    // --- Game Logic ---
    startGame() {
        this.showScreen(null); // Hide all screens
        document.getElementById('hud').style.display = 'flex';
        
        // Reset Game
        this.player = new Player(SKINS[this.userData.currentSkin]);
        this.holds = [];
        this.cameraY = 0;
        this.gameRunning = true;
        this.frameCount = 0;
        
        // Initial Holds
        this.generateHold(this.canvas.width/2, this.canvas.height - 100, 'normal'); // Start hold
        for (let i = 0; i < 20; i++) {
            this.spawnNextHold();
        }
        
        // Attach player to first hold
        this.player.currentHold = this.holds[0];
        this.player.x = this.holds[0].x;
        this.player.y = this.holds[0].y + 25;

        // Start Loop
        requestAnimationFrame(() => this.loop());
    }

    generateHold(x, y, type) {
        const hold = new Hold(x, y, type);
        this.holds.push(hold);
        return hold;
    }

    spawnNextHold() {
        const highestHold = this.holds[this.holds.length - 1];
        const minY = highestHold.y - 180 * this.player.skin.jumpMult; // Max jump height approx
        const maxY = highestHold.y - 80;
        
        const nextY = Math.random() * (maxY - minY) + minY;
        
        // Zigzag logic
        let nextX;
        if (highestHold.x < this.canvas.width / 2) {
            nextX = Math.random() * (this.canvas.width/2 - 40) + this.canvas.width/2;
        } else {
            nextX = Math.random() * (this.canvas.width/2 - 40) + 20;
        }

        // Determine Type based on Zone
        const dist = Math.abs(nextY) / 10; // Approx distance
        let currentZone = CONSTANTS.ZONES[0];
        for(let z of CONSTANTS.ZONES) {
            if(dist >= z.start) currentZone = z;
        }

        let type = 'normal';
        if (Math.random() < 0.3) {
            type = currentZone.holdTypes[Math.floor(Math.random() * currentZone.holdTypes.length)];
        }

        this.generateHold(nextX, nextY, type);
    }

    handleInput() {
        if (!this.gameRunning) return;

        if (this.player.state === 'ON_HOLD') {
            this.player.jump();
        } else if (this.player.state === 'JUMPING') {
            const grabbed = this.player.tryGrab(this.holds);
            // Visual feedback for grab attempt could go here
        }
    }

    loop() {
        if (!this.gameRunning) return;

        // 1. Update
        this.player.update(this.holds, null, this.cameraY);
        
        // Generate more holds if needed
        const highestHold = this.holds[this.holds.length - 1];
        if (highestHold.y > this.cameraY - 100) {
            this.spawnNextHold();
        }

        // Update Holds
        this.holds.forEach(h => h.update(1, this.player.y));

        // Camera Follow
        const targetCamY = this.player.y - this.canvas.height / 2;
        if (targetCamY < this.cameraY) {
            this.cameraY = targetCamY; // Only scroll up
        }

        // Check Zone
        let currentZoneIdx = 0;
        for(let i=0; i<CONSTANTS.ZONES.length; i++) {
            if (this.player.scoreDistance >= CONSTANTS.ZONES[i].start) currentZoneIdx = i;
        }
        
        // Zone UI
        const zoneTag = document.getElementById('zoneTag');
        if (zoneTag.innerText !== CONSTANTS.ZONES[currentZoneIdx].name) {
            zoneTag.innerText = CONSTANTS.ZONES[currentZoneIdx].name;
            zoneTag.style.opacity = 1;
            setTimeout(() => zoneTag.style.opacity = 0, 3000);
        }

        // Cleanup old holds
        this.holds = this.holds.filter(h => h.y < this.cameraY + this.canvas.height + 200);

        // HUD Update
        document.querySelector('.hud-dist').innerText = `${this.player.scoreDistance}m`;
        document.querySelector('.hud-gold').innerText = `${this.player.collectedGold} G`;

        // Check Death
        if (this.player.state === 'DEAD') {
            this.gameOver();
            return;
        }

        // 2. Draw
        this.draw();

        this.frameCount++;
        requestAnimationFrame(() => this.loop());
    }

    draw() {
        // Clear background based on Zone
        let bgCol = '#333';
        for(let z of CONSTANTS.ZONES) {
            if (this.player.scoreDistance >= z.start) bgCol = z.color;
        }
        
        this.ctx.fillStyle = bgCol;
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        this.ctx.save();
        this.ctx.translate(0, -this.cameraY); // Apply Camera

        // Draw Guide Lines (Walls)
        this.ctx.fillStyle = 'rgba(0,0,0,0.3)';
        this.ctx.fillRect(0, this.cameraY, 10, this.canvas.height);
        this.ctx.fillRect(this.canvas.width-10, this.cameraY, 10, this.canvas.height);

        // Draw Holds
        this.holds.forEach(hold => hold.draw(this.ctx));

        // Draw Player
        this.player.draw(this.ctx);

        // Green Circle Indicator (if near hold)
        if (this.player.state === 'JUMPING') {
             for (let hold of this.holds) {
                if (!hold.active) continue;
                const dx = this.player.x - hold.x;
                const dy = (this.player.y - 25) - hold.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < CONSTANTS.GAME.HOLD_GRAB_DIST + 20) { // Slightly larger visual range
                    this.ctx.beginPath();
                    this.ctx.arc(hold.x, hold.y, hold.radius + 10, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#00FF00';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                }
             }
        }

        this.ctx.restore();
    }

    gameOver() {
        this.gameRunning = false;
        
        // Calculate Rewards
        const distGold = Math.floor(this.player.scoreDistance / 10);
        const totalGold = (distGold + this.player.collectedGold);
        
        // Save Data
        this.userData.gold += totalGold;
        if (this.player.scoreDistance > this.userData.bestDist) {
            this.userData.bestDist = this.player.scoreDistance;
        }
        this.saveData();

        // Update UI
        document.getElementById('go-dist').innerText = this.player.scoreDistance;
        document.getElementById('go-gold').innerText = `+${totalGold}`;
        document.getElementById('go-best').innerText = this.userData.bestDist;
        
        setTimeout(() => {
            this.showScreen('screen-gameover');
            document.getElementById('hud').style.display = 'none';
        }, 500);
    }

    // --- UI Helpers ---
    showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        if (id) document.getElementById(id).classList.add('active');
    }

    updateMenuUI() {
        document.getElementById('menu-username').innerText = this.user;
        document.getElementById('menu-gold').innerText = `${this.userData.gold} G`;
        document.getElementById('menu-best').innerText = `${this.userData.bestDist}m`;
    }

    openShop() {
        this.renderShop();
        this.showScreen('screen-shop');
    }

    renderShop() {
        const grid = document.getElementById('shop-list');
        grid.innerHTML = '';
        document.getElementById('shop-gold').innerText = this.userData.gold;

        Object.keys(SKINS).forEach(key => {
            const skin = SKINS[key];
            const unlocked = this.userData.skins.includes(key);
            const selected = this.userData.currentSkin === key;

            const card = document.createElement('div');
            card.className = `skin-card ${!unlocked ? 'locked' : ''} ${selected ? 'selected' : ''}`;
            
            let btnHTML = '';
            if (selected) {
                btnHTML = '<div style="color:#0f0; font-weight:bold;">‚úì Ïû•Ï∞©Ï§ë</div>';
            } else if (unlocked) {
                btnHTML = `<button class="btn btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="gameApp.equipSkin('${key}')">Ïû•Ï∞©</button>`;
            } else {
                btnHTML = `<button class="btn btn-secondary" style="padding:5px 10px; font-size:12px; background:var(--primary); color:black;" onclick="gameApp.buySkin('${key}')">${skin.price} G</button>`;
            }

            card.innerHTML = `
                <div class="skin-icon" style="color:${skin.color}">${skin.icon}</div>
                <div class="skin-name">${skin.name}</div>
                <div class="skin-desc">${skin.desc}</div>
                <div style="margin-top:5px;">${btnHTML}</div>
            `;
            grid.appendChild(card);
        });
    }

    buySkin(key) {
        const skin = SKINS[key];
        if (this.userData.gold >= skin.price) {
            this.userData.gold -= skin.price;
            this.userData.skins.push(key);
            this.saveData();
            this.renderShop();
        } else {
            alert('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');
        }
    }

    equipSkin(key) {
        this.userData.currentSkin = key;
        this.saveData();
        this.renderShop();
    }
}

// Start App
const gameApp = new GameApp();

</script>
</body>
</html>