<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Climbing Knights</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Noto+Sans+KR:wght@400;700&display=swap');
        :root { --primary: #FFD700; --danger: #FF4444; --ui-bg: rgba(0, 0, 0, 0.9); }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Noto Sans KR', sans-serif; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none; }
        #game-container { position: relative; width: 100%; max-width: 480px; height: 100%; background: #222; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--ui-bg); z-index: 10; }
        .hidden { display: none !important; }
        .box { background: #333; padding: 30px; border-radius: 15px; border: 2px solid var(--primary); text-align: center; width: 80%; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: 5px; background: var(--primary); color: black; font-weight: bold; cursor: pointer; font-size: 18px; }
        #hud { position: absolute; top: 20px; left: 20px; z-index: 5; font-family: 'Black Ops One', cursive; font-size: 24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="hud" class="hidden">
        <div id="dist-txt">0m</div>
        <div id="zone-txt" style="font-size: 14px; color: var(--primary);">BASIC ZONE</div>
    </div>

    <div id="login-screen" class="ui-layer">
        <h1 style="font-family: 'Black Ops One'; color: var(--primary); font-size: 40px; margin-bottom: 5px;">CLIMBING KNIGHTS</h1>
        <p style="margin-bottom: 20px; color: #aaa;">Ascend the Demon King's Tower</p>
        <div class="box">
            <input type="text" id="username" placeholder="유저명">
            <input type="password" id="password" placeholder="비밀번호">
            <button onclick="game.login()">Login</button>
        </div>
    </div>

    <div id="main-menu" class="ui-layer hidden">
        <h2 id="welcome-msg" style="color: var(--primary);">님, 안녕하세요!</h2>
        <p>최고 기록: <span id="best-dist">0</span>m</p>
        <button style="width: 220px;" onclick="game.start()">스토리 모드 시작</button>
        <button style="width: 220px; background: #555; color: white;" onclick="game.logout()">로그아웃</button>
    </div>

    <div id="game-over" class="ui-layer hidden">
        <h1 id="over-title" style="color: var(--danger); font-size: 40px;">실패</h1>
        <p id="over-stats"></p>
        <button style="width: 200px;" onclick="game.start()">재도전</button>
        <button style="width: 200px; background: #555; color: white;" onclick="game.showMenu()">메뉴로</button>
    </div>

    <canvas id="gameCanvas"></canvas>
</div>

<script>
/**
 * Climbing Knights - Full Implementation
 */

const CONFIG = {
    WIDTH: 480, HEIGHT: 854,
    GRAVITY: 0.35, JUMP_SPEED: 16,
    HOLD_TYPES: ['normal', 'breaking', 'rock_bug', 'rock_bug_v', 'snow_bug', 'ice', 'lava_bug', 'lava', 'magic', 'trap']
};

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = CONFIG.WIDTH;
        this.canvas.height = CONFIG.HEIGHT;
        
        this.state = 'LOGIN';
        this.user = null;
        this.distance = 0;
        this.cameraY = 0;
        this.player = null;
        this.holds = [];
        this.rocks = [];
        this.goblins = [];
        this.timer = 0;

        this.init();
        this.bindEvents();
    }

    init() {
        const saved = localStorage.getItem('ck_logged_in');
        if (saved) {
            this.user = JSON.parse(localStorage.getItem(`ck_user_${saved}`));
            this.showMenu();
        }
    }

    bindEvents() {
        this.canvas.addEventListener('mousedown', (e) => this.handleInput(e));
        this.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.handleInput(e); });
    }

    login() {
        const name = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value.trim();
        if(!name || !pass) return alert("입력해줘!");
        
        let data = localStorage.getItem(`ck_user_${name}`);
        if(data) {
            data = JSON.parse(data);
            if(data.pass !== pass) return alert("비밀번호 틀림!");
            this.user = data;
        } else {
            this.user = { name, pass, best: 0 };
        }
        localStorage.setItem('ck_logged_in', name);
        this.save();
        this.showMenu();
    }

    save() { localStorage.setItem(`ck_user_${this.user.name}`, JSON.stringify(this.user)); }
    logout() { localStorage.removeItem('ck_logged_in'); location.reload(); }

    showMenu() {
        this.state = 'MENU';
        document.getElementById('login-screen').className = 'ui-layer hidden';
        document.getElementById('game-over').className = 'ui-layer hidden';
        document.getElementById('main-menu').className = 'ui-layer';
        document.getElementById('welcome-msg').innerText = `${this.user.name} 기사, 준비되었나?`;
        document.getElementById('best-dist').innerText = this.user.best;
    }

    start() {
        this.state = 'PLAYING';
        this.distance = 0;
        this.cameraY = 0;
        this.timer = 0;
        this.rocks = [];
        this.goblins = [];
        document.getElementById('main-menu').className = 'ui-layer hidden';
        document.getElementById('game-over').className = 'ui-layer hidden';
        document.getElementById('hud').className = '';

        this.player = {
            x: CONFIG.WIDTH/2, y: CONFIG.HEIGHT-120, vx: 0, vy: 0, radius: 25,
            onHold: null, arrowAngle: 0, arrowDir: 1, grabReady: false,
            rotation: 0
        };

        this.holds = [{ x: CONFIG.WIDTH/2, y: CONFIG.HEIGHT-80, type: 'normal', active: true }];
        this.player.onHold = this.holds[0];
        
        for(let i=0; i<8; i++) this.spawnHold();
        this.loop();
    }

    handleInput() {
        if(this.state !== 'PLAYING') return;
        
        if(this.player.onHold) {
            // 점프
            const rad = (this.player.arrowAngle - 90) * Math.PI / 180;
            this.player.vx = CONFIG.JUMP_SPEED * Math.cos(rad);
            this.player.vy = CONFIG.JUMP_SPEED * Math.sin(rad);
            this.player.onHold = null;
            this.player.grabReady = false;
            setTimeout(() => this.player.grabReady = true, 150); // 재잡기 방지
        } else {
            // 잡기 시도
            const target = this.holds.find(h => {
                const d = Math.hypot(this.player.x - h.x, this.player.y - h.y);
                return h.active && d < 55 && this.player.grabReady;
            });
            if(target) {
                this.player.onHold = target;
                this.player.vx = 0; this.player.vy = 0;
                if(target.type === 'breaking') target.timer = 120; // 2초 (60fps)
                if(target.type === 'trap') this.spawnGoblin(target);
            }
        }
    }

    spawnHold() {
        const last = this.holds[this.holds.length-1];
        const zone = this.getZone();
        let newX, newY = last.y - (180 + Math.random() * 80);
        
        if(last.x < CONFIG.WIDTH/2) newX = CONFIG.WIDTH/2 + Math.random() * (CONFIG.WIDTH/2 - 50);
        else newX = 50 + Math.random() * (CONFIG.WIDTH/2 - 50);

        let type = 'normal';
        const rand = Math.random();
        if(rand < 0.2) {
            if(zone === 'BASIC') type = Math.random() < 0.15 ? 'breaking' : 'normal';
            else if(zone === 'ROCK') type = Math.random() < 0.5 ? 'rock_bug' : 'rock_bug_v';
            else if(zone === 'SNOW') type = Math.random() < 0.5 ? 'snow_bug' : 'ice';
            else if(zone === 'LAVA') type = Math.random() < 0.5 ? 'lava_bug' : 'lava';
            else type = Math.random() < 0.5 ? 'magic' : 'trap';
        } else if(rand < 0.35) type = 'breaking';

        this.holds.push({ 
            x: newX, y: newY, type, active: true, 
            timer: 0, angle: Math.random() * Math.PI * 2,
            originX: newX, originY: newY
        });
    }

    spawnGoblin(hold) {
        setTimeout(() => {
            if(this.state === 'PLAYING') this.goblins.push({ x: hold.x, y: hold.y - 400, vy: 5 });
        }, 2000);
    }

    getZone() {
        if(this.distance < 2000) return 'BASIC';
        if(this.distance < 4000) return 'ROCK';
        if(this.distance < 6000) return 'SNOW';
        if(this.distance < 8000) return 'LAVA';
        return 'CASTLE';
    }

    update() {
        this.timer++;
        const p = this.player;

        if(p.onHold) {
            p.x = p.onHold.x;
            p.y = p.onHold.y;
            p.arrowAngle += 2 * p.arrowDir;
            if(Math.abs(p.arrowAngle) > 60) p.arrowDir *= -1;
            
            // 특수 홀드 로직
            if(p.onHold.type === 'breaking') {
                p.onHold.timer--;
                if(p.onHold.timer <= 0) { p.onHold.active = false; p.onHold = null; }
            }
            if(p.onHold.type === 'ice') p.onHold.y += 1.5;
        } else {
            p.vy += CONFIG.GRAVITY;
            p.x += p.vx; p.y += p.vy;
            p.rotation += 5;
            // 벽 충돌
            if(p.x < p.radius || p.x > CONFIG.WIDTH - p.radius) {
                p.vx *= -0.6;
                p.x = p.x < p.radius ? p.radius : CONFIG.WIDTH - p.radius;
            }
        }

        // 카메라 추적
        let targetCam = p.y - CONFIG.HEIGHT * 0.6;
        this.cameraY += (targetCam - this.cameraY) * 0.1;

        // 홀드 업데이트
        this.holds.forEach(h => {
            if(h.type === 'rock_bug') h.x = h.originX + Math.sin(this.timer * 0.05) * 100;
            if(h.type === 'rock_bug_v') h.y = h.originY + Math.sin(this.timer * 0.05) * 80;
            if(h.type === 'snow_bug') h.x = h.originX + Math.sin(this.timer * 0.08) * 120;
            if(h.type === 'lava_bug') {
                h.x = h.originX + Math.cos(this.timer * 0.1) * 80;
                h.y = h.originY + Math.sin(this.timer * 0.1) * 80;
            }
            if(h.type === 'lava') h.active = (this.timer % 360 < 240); // 4초 보임, 2초 안보임
            if(h.type === 'magic') {
                if(this.timer % 90 === 0) {
                    h.x = h.originX + (Math.random()-0.5) * 200;
                    h.y = h.originY + (Math.random()-0.5) * 100;
                }
            }
        });

        // 장애물 (바위)
        if(this.getZone() === 'ROCK' && this.timer % 120 === 0) {
            this.rocks.push({ x: Math.random()*CONFIG.WIDTH, y: this.cameraY - 50, vy: 4 + Math.random()*3 });
        }
        this.rocks.forEach(r => {
            r.y += r.vy;
            if(Math.hypot(p.x - r.x, p.y - r.y) < p.radius + 20) this.die();
        });

        // 고블린
        this.goblins.forEach(g => {
            g.y += g.vy;
            if(Math.hypot(p.x - g.x, p.y - g.y) < p.radius + 25) this.die();
        });

        // 거리 갱신
        this.distance = Math.max(this.distance, Math.floor((CONFIG.HEIGHT - 120 - p.y)/10));
        document.getElementById('dist-txt').innerText = this.distance + "m";
        document.getElementById('zone-txt').innerText = this.getZone() + " ZONE";

        if(this.holds[this.holds.length-1].y > p.y - 800) this.spawnHold();
        if(p.y > this.cameraY + CONFIG.HEIGHT + 100) this.die();
        if(this.distance >= 10000) this.win();
    }

    die() {
        this.state = 'GAMEOVER';
        if(this.distance > this.user.best) { this.user.best = this.distance; this.save(); }
        document.getElementById('over-title').innerText = "원정 실패";
        document.getElementById('over-stats').innerText = `기록: ${this.distance}m\n(목표: 10,000m)`;
        document.getElementById('game-over').className = 'ui-layer';
    }

    win() {
        this.state = 'GAMEOVER';
        document.getElementById('over-title').innerText = "탑의 정복자!";
        document.getElementById('over-title').style.color = "var(--primary)";
        document.getElementById('over-stats').innerText = "축하합니다! 마왕성을 정복했습니다.";
        document.getElementById('game-over').className = 'ui-layer';
    }

    draw() {
        const ctx = this.ctx;
        ctx.clearRect(0,0, CONFIG.WIDTH, CONFIG.HEIGHT);

        // 홀드 그리기
        this.holds.forEach(h => {
            if(!h.active) return;
            ctx.fillStyle = this.getHoldColor(h.type);
            ctx.beginPath();
            if(h.type === 'ice') ctx.rect(h.x - 90, h.y - this.cameraY - 20, 180, 40);
            else ctx.arc(h.x, h.y - this.cameraY, 30, 0, Math.PI*2);
            ctx.fill();
            
            // 잡기 가능 표시
            if(!this.player.onHold && Math.hypot(this.player.x - h.x, this.player.y - h.y) < 55) {
                ctx.strokeStyle = '#0f0'; ctx.lineWidth = 3; ctx.stroke();
            }
        });

        // 장애물
        ctx.fillStyle = '#666';
        this.rocks.forEach(r => {
            ctx.beginPath(); ctx.arc(r.x, r.y - this.cameraY, 20, 0, Math.PI*2); ctx.fill();
        });
        ctx.fillStyle = '#800';
        this.goblins.forEach(g => {
            ctx.beginPath(); ctx.arc(g.x, g.y - this.cameraY, 25, 0, Math.PI*2); ctx.fill();
        });

        // 플레이어
        ctx.save();
        ctx.translate(this.player.x, this.player.y - this.cameraY);
        if(!this.player.onHold) ctx.rotate(this.player.rotation * Math.PI / 180);
        ctx.fillStyle = '#fff';
        ctx.fillRect(-25, -25, 50, 50); // 실제 구현시 drawImage 사용
        
        if(this.player.onHold) {
            // 화살표
            ctx.rotate(this.player.arrowAngle * Math.PI / 180);
            ctx.fillStyle = 'red';
            ctx.beginPath(); ctx.moveTo(-5, -40); ctx.lineTo(0, -60); ctx.lineTo(5, -40); ctx.fill();
        }
        ctx.restore();
    }

    getHoldColor(type) {
        switch(type) {
            case 'breaking': return '#f44';
            case 'ice': return '#9df';
            case 'lava': return '#f80';
            case 'magic': return '#a4f';
            case 'trap': return '#444';
            default: return '#853';
        }
    }

    loop() {
        if(this.state !== 'PLAYING') return;
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
}

const game = new Game();
</script>
</body>
</html>